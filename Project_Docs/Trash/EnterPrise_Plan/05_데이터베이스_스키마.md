================================================================================
데이터베이스 스키마 설계
================================================================================

작성일: 2026-01-20
목적: PostgreSQL 데이터베이스 테이블 구조 및 관계 정의


데이터베이스 개요
================================================================================

데이터베이스명: trend_db
DBMS: PostgreSQL 15+
ORM: SQLAlchemy 2.0 (비동기)
마이그레이션: Alembic


전체 테이블 구조
================================================================================

1. trending_keywords      # 트렌드 키워드 마스터
2. raw_data              # 원시 수집 데이터
3. normalized_data       # 정규화된 데이터
4. keyword_scores        # 키워드별 점수
5. daily_rankings        # 일일 랭킹
6. reports               # 리포트 메타데이터
7. published_posts       # 발행된 게시물
8. collection_logs       # 수집 로그


1. trending_keywords 테이블
================================================================================

목적: 발견된 트렌드 키워드 관리

컬럼 정의
---
id                     (INTEGER, PK, AUTO_INCREMENT)
keyword                (VARCHAR(200), NOT NULL, INDEX)
country                (CHAR(2), NOT NULL, INDEX)  # KR, JP, TW, US, ID
first_discovered_at    (TIMESTAMP, NOT NULL)
last_seen_at           (TIMESTAMP, NOT NULL)
status                 (VARCHAR(20), DEFAULT 'active')  # active, declining, dead
custom_keyword         (BOOLEAN, DEFAULT FALSE)  # 사용자 지정 여부
created_at             (TIMESTAMP, DEFAULT NOW())
updated_at             (TIMESTAMP, DEFAULT NOW())

인덱스
---
UNIQUE INDEX: (keyword, country)
INDEX: (country, last_seen_at)
INDEX: (status)

샘플 데이터
---
id: 1
keyword: AI 트렌드
country: KR
first_discovered_at: 2026-01-19 09:00:00
last_seen_at: 2026-01-20 12:00:00
status: active
custom_keyword: false


2. raw_data 테이블
================================================================================

목적: API에서 수집한 원시 데이터 저장

컬럼 정의
---
id                  (BIGINT, PK, AUTO_INCREMENT)
source              (VARCHAR(50), NOT NULL, INDEX)  # google_trends, youtube, etc
keyword_id          (INTEGER, FK -> trending_keywords.id)
country             (CHAR(2), NOT NULL, INDEX)
data_type           (VARCHAR(50))  # video, post, article, trend_data
external_id         (VARCHAR(200))  # 원본 플랫폼의 ID
url                 (TEXT)
title               (TEXT)
content             (TEXT)
metadata            (JSONB)  # 플랫폼별 추가 정보
metrics             (JSONB)  # 조회수, 좋아요 등
published_at        (TIMESTAMP)
collected_at        (TIMESTAMP, DEFAULT NOW(), INDEX)
created_at          (TIMESTAMP, DEFAULT NOW())

인덱스
---
INDEX: (source, collected_at)
INDEX: (keyword_id, source)
INDEX: (country, collected_at)
UNIQUE INDEX: (source, external_id)  # 중복 방지

JSONB 구조 예시
---
metadata: {
  "channel_name": "테크 유튜버",
  "channel_id": "UC1234567890",
  "tags": ["AI", "기술"],
  "duration": 600
}

metrics: {
  "views": 100000,
  "likes": 5000,
  "comments": 300,
  "shares": 50
}


3. normalized_data 테이블
================================================================================

목적: 플랫폼별 데이터를 통일된 형식으로 정규화

컬럼 정의
---
id                  (BIGINT, PK, AUTO_INCREMENT)
raw_data_id         (BIGINT, FK -> raw_data.id)
keyword_id          (INTEGER, FK -> trending_keywords.id)
source              (VARCHAR(50), NOT NULL)
country             (CHAR(2), NOT NULL)
title               (TEXT)
url                 (TEXT, UNIQUE)
views               (BIGINT, DEFAULT 0)
likes               (INTEGER, DEFAULT 0)
comments            (INTEGER, DEFAULT 0)
shares              (INTEGER, DEFAULT 0)
engagement_rate     (DECIMAL(5,2))  # (likes+comments+shares) / views * 100
published_at        (TIMESTAMP)
normalized_at       (TIMESTAMP, DEFAULT NOW())
created_at          (TIMESTAMP, DEFAULT NOW())

인덱스
---
INDEX: (keyword_id, country)
INDEX: (source, normalized_at)
INDEX: (engagement_rate DESC)

계산 컬럼
---
engagement_rate = ((likes + comments * 2 + shares * 3) / views) * 100


4. keyword_scores 테이블
================================================================================

목적: 키워드별 핫이슈 점수 저장

컬럼 정의
---
id                      (BIGINT, PK, AUTO_INCREMENT)
keyword_id              (INTEGER, FK -> trending_keywords.id)
country                 (CHAR(2), NOT NULL)
date                    (DATE, NOT NULL, INDEX)
hour                    (SMALLINT)  # 0-23, 시간대별 점수 (옵션)

# 점수 상세
popularity_score        (DECIMAL(5,2))  # 0-40
momentum_score          (DECIMAL(5,2))  # 0-30
recency_score           (DECIMAL(5,2))  # 0-20
multi_source_score      (DECIMAL(5,2))  # 0-10
total_score             (DECIMAL(6,2))  # 0-100

# 점수 산정 근거
data_count              (INTEGER)  # 집계된 데이터 개수
unique_sources          (INTEGER)  # 출처 개수
growth_rate_24h         (DECIMAL(8,2))  # 24시간 증가율 (%)
recent_post_count       (INTEGER)

calculated_at           (TIMESTAMP, DEFAULT NOW())
created_at              (TIMESTAMP, DEFAULT NOW())

인덱스
---
UNIQUE INDEX: (keyword_id, country, date, hour)
INDEX: (country, date, total_score DESC)
INDEX: (date, momentum_score DESC)  # 급상승 조회용


5. daily_rankings 테이블
================================================================================

목적: 일일 키워드 랭킹 스냅샷

컬럼 정의
---
id                  (BIGINT, PK, AUTO_INCREMENT)
date                (DATE, NOT NULL, INDEX)
country             (CHAR(2), NOT NULL)
ranking_type        (VARCHAR(20), NOT NULL)  # top_20, rising_10
rank                (SMALLINT, NOT NULL)
keyword_id          (INTEGER, FK -> trending_keywords.id)
total_score         (DECIMAL(6,2))
momentum_score      (DECIMAL(5,2))
created_at          (TIMESTAMP, DEFAULT NOW())

인덱스
---
UNIQUE INDEX: (date, country, ranking_type, rank)
INDEX: (country, date, ranking_type)

샘플 데이터
---
date: 2026-01-20
country: KR
ranking_type: top_20
rank: 1
keyword_id: 15
total_score: 91.5
momentum_score: 28.0


6. reports 테이블
================================================================================

목적: 생성된 리포트 메타데이터 관리

컬럼 정의
---
id                  (BIGINT, PK, AUTO_INCREMENT)
report_type         (VARCHAR(50), NOT NULL)  # daily, weekly, trending
country             (CHAR(2), NOT NULL)
start_date          (DATE, NOT NULL)
end_date            (DATE, NOT NULL)
title               (VARCHAR(300))
summary             (TEXT)
keyword_count       (INTEGER)
data_count          (INTEGER)
file_path           (VARCHAR(500))  # Google Sheets URL 또는 파일 경로
generated_at        (TIMESTAMP, DEFAULT NOW())
created_at          (TIMESTAMP, DEFAULT NOW())

인덱스
---
INDEX: (country, generated_at DESC)
INDEX: (report_type, generated_at DESC)


7. published_posts 테이블
================================================================================

목적: Threads/Instagram에 발행된 게시물 기록

컬럼 정의
---
id                  (BIGINT, PK, AUTO_INCREMENT)
platform            (VARCHAR(20), NOT NULL)  # threads, instagram
keyword_id          (INTEGER, FK -> trending_keywords.id)
post_content        (TEXT, NOT NULL)
hashtags            (VARCHAR(500))
image_url           (TEXT)  # 카드뉴스 이미지 (옵션)
status              (VARCHAR(20), DEFAULT 'draft')  # draft, approved, published
external_post_id    (VARCHAR(200))  # 플랫폼의 게시물 ID
post_url            (TEXT)
scheduled_at        (TIMESTAMP)
published_at        (TIMESTAMP)
approval_required   (BOOLEAN, DEFAULT TRUE)
approved_by         (VARCHAR(100))  # 승인자
approved_at         (TIMESTAMP)
created_at          (TIMESTAMP, DEFAULT NOW())

인덱스
---
INDEX: (platform, status)
INDEX: (published_at DESC)
INDEX: (keyword_id)


8. collection_logs 테이블
================================================================================

목적: 데이터 수집 작업 로그 및 에러 추적

컬럼 정의
---
id                  (BIGINT, PK, AUTO_INCREMENT)
job_id              (VARCHAR(100), NOT NULL, INDEX)  # UUID
source              (VARCHAR(50), NOT NULL)
country             (CHAR(2))
status              (VARCHAR(20), NOT NULL)  # started, success, failed
items_collected     (INTEGER, DEFAULT 0)
error_message       (TEXT)
started_at          (TIMESTAMP, NOT NULL)
completed_at        (TIMESTAMP)
duration_seconds    (INTEGER)
created_at          (TIMESTAMP, DEFAULT NOW())

인덱스
---
INDEX: (source, started_at DESC)
INDEX: (status, started_at DESC)


테이블 간 관계도 (ERD)
================================================================================

trending_keywords (1) --- (N) raw_data
trending_keywords (1) --- (N) normalized_data
trending_keywords (1) --- (N) keyword_scores
trending_keywords (1) --- (N) daily_rankings
trending_keywords (1) --- (N) published_posts

raw_data (1) --- (1) normalized_data


데이터 보관 정책
================================================================================

1. raw_data
   - 30일 경과 데이터는 압축 후 아카이브
   - 90일 이후 삭제

2. normalized_data
   - 60일간 보관
   - 이후 집계 데이터만 유지

3. keyword_scores
   - 1년간 보관
   - 분석용 데이터로 활용

4. collection_logs
   - 성공 로그: 7일 보관
   - 에러 로그: 30일 보관


Alembic 마이그레이션 명령어
================================================================================

초기 마이그레이션 생성
---
명령어: alembic revision --autogenerate -m "Initial schema"
설명: 모델 기반으로 마이그레이션 파일 자동 생성

마이그레이션 적용
---
명령어: alembic upgrade head
설명: 최신 버전으로 DB 스키마 업그레이드

롤백
---
명령어: alembic downgrade -1
설명: 이전 버전으로 롤백

현재 버전 확인
---
명령어: alembic current
설명: 현재 적용된 마이그레이션 버전 확인


SQLAlchemy 모델 예시 (models/keyword.py)
================================================================================

from sqlalchemy import Column, Integer, String, Boolean, TIMESTAMP
from sqlalchemy.sql import func
from src.core.database import Base

class TrendingKeyword(Base):
    __tablename__ = 'trending_keywords'
    
    id = Column(Integer, primary_key=True, index=True)
    keyword = Column(String(200), nullable=False, index=True)
    country = Column(String(2), nullable=False, index=True)
    first_discovered_at = Column(TIMESTAMP, nullable=False)
    last_seen_at = Column(TIMESTAMP, nullable=False)
    status = Column(String(20), default='active')
    custom_keyword = Column(Boolean, default=False)
    created_at = Column(TIMESTAMP, server_default=func.now())
    updated_at = Column(TIMESTAMP, server_default=func.now(), onupdate=func.now())


다음 단계
================================================================================

1. SQLAlchemy 모델 작성
   - models/ 디렉토리에 각 테이블별 모델 파일 생성

2. Alembic 초기화
   명령어: alembic init alembic
   설명: Alembic 설정 파일 생성

3. DB 연결 설정
   - core/database.py에 비동기 엔진 설정

4. 마이그레이션 실행
   명령어: alembic upgrade head
   설명: 실제 DB에 테이블 생성
